## 目标与约束
- 平滑同步 `ostris/ai-toolkit:main` 的最近 14 个提交到当前仓库。
- 保留并验证三类本地改动：UI 中文化与自适应调整、Qwen Image Edit 多图训练修复、前端数据集读取 JSON 问题修复。
- 不修改核心设计；尽量减少冲突并保持现有工作流。

## 差异审计
- 当前分支状态：本地分支领先 25 个提交，落后上游 14 个提交。
- 重点关注的易冲突目录与文件：
  - `ui/`（Next.js 与组件更新、中文化）：尤其 `ui/src/app/jobs/new/options.ts:516`（Z-Image 训练适配器默认 v2 路径），以及表单/导入 JSON 的解析组件。
  - `extensions_built_in/diffusion_models/qwen_image*`（Qwen Image Edit 相关修复与新支持）。
  - `extensions_built_in/diffusion_models/z_image/`（Z-Image Turbo/De-Turbo 的适配与默认设置）。
  - `toolkit/` 下的训练与数据加载、提示嵌入、调度器等（上游有 PromptEmbeds 重构、采样器与 offloading 修复）。

## 分支与合并策略
- 新建集成分支：`sync/upstream-2025-12-24`。
- 添加并校验上游远程：`upstream` 指向 `https://github.com/ostris/ai-toolkit`。
- 执行流程：
  1. `git fetch upstream` 拉取上游最新。
  2. 在 `sync/upstream-2025-12-24` 分支上执行 `git merge --no-ff upstream/main`，优先采用合并（而非 rebase）以保留本地历史与修复提交的语义。
  3. 按模块分批解决冲突（UI → 扩展 → 核心工具），每次解决后运行对应验证用例。
  4. 合并完成后，创建合并提交并推送供评审。

## 冲突解决优先级与准则
- UI 中文化与自适应：保留本地中文与布局调整；对于上游功能性改动（如 Next.js 安全修复、Loss Graph 添加），在本地文件中合并其逻辑，再保持中文文案与样式。重点手动审阅：
  - `ui/src/app/jobs/new/options.ts:516` Z-Image 训练适配器默认值与路径。
  - 导入 JSON 的表单解析与校验组件（确保继续接受 JSON 配置并避免此前的解析异常）。
- Qwen Image Edit 多图训练：保留现有修复点，并对上游“新增 2511/plus”支持进行接口适配，确认 `conditional/unconditional` embeds 生成、`prompt_kwargs` 追踪和 `control_images` 多图路径传递仍正确。
- Z-Image 相关：合并上游 ramtorch layer offloading 修复、默认训练适配器 v2、De-Turbo 支持；本地逻辑保持不变并验证 16GB 显卡可用性相关配置（`low_vram`, 量化与 offloading 选择）。

## 验证矩阵
- UI 层：
  - `npm run build_and_start` 启动；确认 Next.js 版本安全修复后的可用性；Loss Graph 正常显示。
  - JSON 导入：在“新建训练任务”页导入数据集 JSON，确认无解析/类型错误。
- 训练层：
  - Qwen Image Edit 多图：使用多图数据集跑短流程（少步数），确认不再出现之前的 `UnboundLocalError/ConditionalImage` 等问题，日志与样例输出正常。
  - Z-Image：分别验证 Turbo 与 De-Turbo，确认默认 v2 训练适配器路径与加载无误；在 Windows/16GB 环境下检查预处理与 offloading 行为是否稳定。
- 兼容性：
  - 旧配置文件与中文 UI 功能均可用；`run.py` CLI 流程可运行；`requirements.txt` 变更（如去除 easy-diffuse）后依赖安装成功。

## 风险与回滚
- 如 UI 冲突较大，采用“先合并上游 UI，再重放中文化补丁”的方式（保留我们的本地补丁集），必要时 `git revert` 回滚到合并前状态。
- 将本地修复打标签并生成差异报告，便于后续持续跟进上游变更。

## 交付物
- 分支：`sync/upstream-2025-12-24`，包含合并提交与冲突解决。
- 差异与冲突清单（文件级粒度）。
- 验证记录（UI 启动截图、训练日志片段与输出示例）。

## 后续维护
- 设置定期同步脚本：每周自动 `fetch` 与差异报告，人工审核后再触发合并。
- 对 UI 中文化与训练修复维持独立补丁目录/标签，降低未来冲突成本。